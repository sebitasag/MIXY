<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mixy - Inicio</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/static/home.css">
    
    <style>
        /* Estilos adicionales */
        .detail-controls {
            display: flex;
            align-items: center;
            gap: 24px;
            padding: 0 24px 24px 24px;
        }

        .btn-play-all {
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background: #6B5FCF;
            border: none;
            color: white;
            font-size: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            box-shadow: 0 8px 16px rgba(107, 95, 207, 0.3);
        }

        .btn-play-all:hover {
            transform: scale(1.06);
            background: #7d6fe0;
        }

        .btn-like {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: transparent;
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            font-size: 18px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .btn-like:hover {
            transform: scale(1.1);
        }

        .btn-like.liked {
            color: #6B5FCF;
            border-color: #6B5FCF;
        }

        /* Notificaciones */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #282828;
            color: white;
            padding: 16px 24px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            gap: 12px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.5);
            z-index: 10000;
            transform: translateX(400px);
            opacity: 0;
            transition: all 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            min-width: 280px;
        }

        .notification.show {
            transform: translateX(0);
            opacity: 1;
        }

        .notification-success { border-left: 4px solid #1db954; }
        .notification-error { border-left: 4px solid #e22134; }
        .notification-info { border-left: 4px solid #3b82f6; }
        .notification-success i { color: #1db954; }
        .notification-error i { color: #e22134; }
        .notification-info i { color: #3b82f6; }

        .notification-progress {
            position: absolute;
            bottom: 0;
            left: 0;
            height: 3px;
            background: rgba(255, 255, 255, 0.3);
            animation: notificationProgress 3s linear forwards;
        }

        @keyframes notificationProgress {
            from { width: 100%; }
            to { width: 0%; }
        }

        /* Cola de reproducci√≥n */
        .queue-section {
            padding: 20px;
            overflow-y: auto;
            max-height: calc(100vh - 500px);
        }

        .queue-section h4 {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 16px;
            color: white;
            font-size: 14px;
            font-weight: 600;
        }

        .queue-item {
            display: grid;
            grid-template-columns: 48px 1fr auto;
            align-items: center;
            gap: 12px;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            background: rgba(255, 255, 255, 0.05);
            margin-bottom: 8px;
        }

        .queue-item:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .queue-item.active {
            background: rgba(107, 95, 207, 0.2);
            border-left: 3px solid #6B5FCF;
        }

        .queue-item-cover {
            width: 48px;
            height: 48px;
            border-radius: 4px;
            overflow: hidden;
        }

        .queue-item-cover img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .queue-item-info h5 {
            margin: 0;
            font-size: 14px;
            color: white;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .queue-item-info p {
            margin: 4px 0 0;
            font-size: 12px;
            color: rgba(255, 255, 255, 0.6);
        }

        .queue-item-remove {
            width: 28px;
            height: 28px;
            border: none;
            background: transparent;
            color: rgba(255, 255, 255, 0.5);
            cursor: pointer;
            border-radius: 50%;
            opacity: 0;
            transition: all 0.2s;
        }

        .queue-item:hover .queue-item-remove {
            opacity: 1;
        }

        .queue-item-remove:hover {
            background: rgba(255, 255, 255, 0.1);
            color: white;
        }

        .track-play-btn {
            width: 32px;
            height: 32px;
            border: none;
            background: transparent;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .track-play-btn:hover {
            transform: scale(1.15);
            color: #6B5FCF;
        }

        .track-row {
            display: grid;
            grid-template-columns: 40px 1fr 80px;
            align-items: center;
            padding: 8px 16px;
            border-radius: 4px;
            transition: background-color 0.2s;
            cursor: pointer;
        }

        .track-row:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }

        .track-row.playing {
            background-color: rgba(107, 95, 207, 0.15);
        }

        .track-row.playing .track-name {
            color: #6B5FCF;
        }

        .detail-header {
            display: flex;
            gap: 24px;
            padding: 24px;
        }

        .detail-cover img {
            width: 232px;
            height: 232px;
            border-radius: 4px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.5);
        }

        .detail-title {
            font-size: 48px;
            font-weight: 900;
            margin: 0;
        }

        .control-btn.active {
            color: #6B5FCF;
        }
    </style>
</head>
<body>
    <aside class="sidebar-left">
        <div class="logo-section">
            <i class="fas fa-circle-play logo-icon"></i>
            <h1>mixy</h1>
        </div>
        
        <nav class="nav-menu">
            <a href="/home" class="nav-item active">
                <i class="fas fa-house"></i>
                <span>Inicio</span>
            </a>
            <a href="/search" class="nav-item">
                <i class="fas fa-magnifying-glass"></i>
                <span>Buscar</span>
            </a>
            <a href="/library" class="nav-item">
                <i class="fas fa-book"></i>
                <span>Tu Biblioteca</span>
            </a>
        </nav>

        <div class="library-section">
            <a href="/create-playlist" class="nav-item">
                <i class="fas fa-plus"></i>
                <span>Crear Playlist</span>
            </a>
            <a href="/favorites" class="nav-item">
                <i class="fas fa-heart"></i>
                <span>Canciones favoritas</span>
            </a>
        </div>

        <div class="user-section">
            <div class="user-info">
                <div class="user-avatar">
                    <i class="fas fa-user"></i>
                </div>
                <span id="user-name">Usuario</span>
            </div>
            
            <a href="#" class="admin-btn" id="admin-access-btn">
                <i class="fas fa-shield-halved"></i>
                Admin Panel
            </a>
            
            <a href="/logout" class="logout-btn">
                <i class="fas fa-right-from-bracket"></i>
                Cerrar Sesi√≥n
            </a>
        </div>
    </aside>

    <main class="main-content">
        <header class="top-bar">
            <div class="nav-buttons">
                <button class="nav-btn" id="btn-back">
                    <i class="fas fa-chevron-left"></i>
                </button>
                <button class="nav-btn" id="btn-forward">
                    <i class="fas fa-chevron-right"></i>
                </button>
            </div>
            <div class="user-profile">
                <span id="user-greeting">Hola</span>
            </div>
        </header>

        <section class="content-wrapper" id="home-view">
            <div class="welcome-section">
                <h1 class="welcome-title" id="welcome-message">Buenas tardes</h1>
            </div>

            <div class="section-header">
                <h2>√Ålbumes Populares</h2>
                <a href="#" class="see-all">Ver todo</a>
            </div>
            <div class="cards-grid" id="albums-container">
                <div class="loading">Cargando √°lbumes...</div>
            </div>

            <div class="section-header">
                <h2>Playlists para ti</h2>
                <a href="#" class="see-all">Ver todo</a>
            </div>
            <div class="cards-grid" id="playlists-container">
                <div class="loading">Cargando playlists...</div>
            </div>

            <div class="section-header">
                <h2>Artistas Populares</h2>
                <a href="#" class="see-all">Ver todo</a>
            </div>
            <div class="artists-grid" id="artists-container">
                <div class="loading">Cargando artistas...</div>
            </div>
        </section>

        <section class="content-wrapper detail-view" id="detail-view" style="display: none;">
            <div class="detail-header">
                <div class="detail-cover">
                    <img id="detail-cover-img" src="" alt="Cover">
                </div>
                <div class="detail-info">
                    <span class="detail-type" id="detail-type">√ÅLBUM</span>
                    <h1 class="detail-title" id="detail-title">T√≠tulo</h1>
                    <div class="detail-meta">
                        <span id="detail-artist">Artista</span>
                        <span class="dot">‚Ä¢</span>
                        <span id="detail-year">2025</span>
                        <span class="dot">‚Ä¢</span>
                        <span id="detail-tracks-count">0 canciones</span>
                    </div>
                </div>
            </div>

            <div class="detail-controls">
                <button class="btn-play-all" id="btn-play-all">
                    <i class="fas fa-play"></i>
                </button>
                <button class="btn-like" id="btn-like-album">
                    <i class="far fa-heart"></i>
                </button>
            </div>

            <div class="tracks-table">
                <div class="tracks-header">
                    <span class="track-number">#</span>
                    <span class="track-title">T√≠tulo</span>
                    <span class="track-duration"><i class="far fa-clock"></i></span>
                </div>
                <div id="tracks-list">
                    <div class="loading">Cargando canciones...</div>
                </div>
            </div>
        </section>
    </main>

    <aside class="sidebar-right">
        <div class="now-playing-header">
            <i class="fas fa-music"></i>
            <h3>Reproduciendo</h3>
        </div>

        <div class="current-track" id="current-track">
            <div class="track-cover">
                <img src="https://via.placeholder.com/300x300/1a1a1a/6B5FCF?text=Mixy" alt="Cover" id="track-cover">
            </div>
            <div class="track-info">
                <h4 id="track-title">Selecciona una canci√≥n</h4>
                <p id="track-artist">---</p>
            </div>
        </div>

        <div class="player-controls">
            <div class="control-buttons">
                <button class="control-btn" id="btn-shuffle">
                    <i class="fas fa-shuffle"></i>
                </button>
                <button class="control-btn" id="btn-prev">
                    <i class="fas fa-backward-step"></i>
                </button>
                <button class="control-btn-main" id="btn-play">
                    <i class="fas fa-play"></i>
                </button>
                <button class="control-btn" id="btn-next">
                    <i class="fas fa-forward-step"></i>
                </button>
                <button class="control-btn" id="btn-repeat">
                    <i class="fas fa-repeat"></i>
                </button>
            </div>
            
            <div class="progress-container">
                <span class="time-current" id="time-current">0:00</span>
                <input type="range" class="progress-bar" id="progress-bar" value="0" max="100">
                <span class="time-total" id="time-total">0:00</span>
            </div>

            <div class="volume-control">
                <i class="fas fa-volume-high"></i>
                <input type="range" class="volume-slider" id="volume-slider" value="80" max="100">
            </div>
        </div>

        <audio id="audio-player" style="display:none;"></audio>

        <div class="queue-section">
            <h4>
                <i class="fas fa-list"></i>
                Cola de reproducci√≥n
            </h4>
            <div class="queue-list" id="queue-list">
                <div class="empty-queue">
                    <i class="fas fa-music"></i>
                    <p>Selecciona un √°lbum o playlist</p>
                </div>
            </div>
        </div>
    </aside>

    <div class="modal" id="admin-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-shield-halved"></i> Panel de Administraci√≥n</h3>
                <button class="close-modal" id="close-admin-modal">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <p>Ingresa la contrase√±a de administrador:</p>
                <input type="password" id="admin-password" placeholder="Contrase√±a" class="admin-input">
                <button class="btn-primary" id="verify-admin-btn">
                    <i class="fas fa-key"></i> Verificar
                </button>
                <div class="error-message" id="admin-error"></div>
            </div>
        </div>
    </div>

    <script>
let currentUser = null;
let currentView = 'home';
let viewHistory = ['home'];
let historyIndex = 0;
let currentAudio = null;
let currentPlaylist = [];
let currentTrackIndex = -1;
let isShuffleOn = false;
let isRepeatOn = false;
let currentAlbumData = null; // NUEVO: Guardar datos del √°lbum actual

document.addEventListener('DOMContentLoaded', () => {
    console.log('üéµ Mixy Home cargado');
    checkSession();
    setupAdminModal();
    setupNavigation();
    setupPlayerControls();
    loadHomeData();
});

function setupNavigation() {
    document.getElementById('btn-back').addEventListener('click', () => {
        if (historyIndex > 0) {
            historyIndex--;
            navigateToView(viewHistory[historyIndex], false);
        }
    });
    
    document.getElementById('btn-forward').addEventListener('click', () => {
        if (historyIndex < viewHistory.length - 1) {
            historyIndex++;
            navigateToView(viewHistory[historyIndex], false);
        }
    });
}

function navigateToView(view, addToHist = true) {
    if (view === 'home') {
        showHomeView();
    } else if (view.startsWith('album:')) {
        const albumId = parseInt(view.split(':')[1]);
        showAlbumDetail(albumId, addToHist);
    } else if (view.startsWith('playlist:')) {
        const playlistId = parseInt(view.split(':')[1]);
        showPlaylistDetail(playlistId, addToHist);
    }
}

function addToHistory(view) {
    viewHistory = viewHistory.slice(0, historyIndex + 1);
    viewHistory.push(view);
    historyIndex = viewHistory.length - 1;
}

function showHomeView() {
    document.getElementById('home-view').style.display = 'block';
    document.getElementById('detail-view').style.display = 'none';
    currentView = 'home';
    currentAlbumData = null;
}

function showDetailView() {
    document.getElementById('home-view').style.display = 'none';
    document.getElementById('detail-view').style.display = 'block';
    currentView = 'detail';
}

async function checkSession() {
    try {
        const response = await fetch('/api/perfil');
        const data = await response.json();
        
        if (data.ok) {
            currentUser = data;
            document.getElementById('user-name').textContent = data.nombre;
            document.getElementById('user-greeting').textContent = `Hola, ${data.nombre}`;
            updateWelcomeMessage();
        } else {
            window.location.href = '/';
        }
    } catch (error) {
        console.error('Error al verificar sesi√≥n:', error);
        window.location.href = '/';
    }
}

function updateWelcomeMessage() {
    const hour = new Date().getHours();
    const welcomeEl = document.getElementById('welcome-message');
    
    if (hour < 12) welcomeEl.textContent = 'Buenos d√≠as';
    else if (hour < 18) welcomeEl.textContent = 'Buenas tardes';
    else welcomeEl.textContent = 'Buenas noches';
}

function setupAdminModal() {
    const adminBtn = document.getElementById('admin-access-btn');
    const modal = document.getElementById('admin-modal');
    const closeBtn = document.getElementById('close-admin-modal');
    const verifyBtn = document.getElementById('verify-admin-btn');
    const passwordInput = document.getElementById('admin-password');
    
    adminBtn.addEventListener('click', (e) => {
        e.preventDefault();
        modal.classList.add('active');
        passwordInput.value = '';
        document.getElementById('admin-error').textContent = '';
    });
    
    closeBtn.addEventListener('click', () => modal.classList.remove('active'));
    modal.addEventListener('click', (e) => {
        if (e.target === modal) modal.classList.remove('active');
    });
    
    verifyBtn.addEventListener('click', verifyAdminPassword);
    passwordInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') verifyAdminPassword();
    });
}

async function verifyAdminPassword() {
    const password = document.getElementById('admin-password').value;
    const errorDiv = document.getElementById('admin-error');
    
    if (!password) {
        errorDiv.textContent = 'Ingresa la contrase√±a';
        errorDiv.classList.add('show');
        return;
    }
    
    try {
        const response = await fetch('/api/admin/verify', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ password })
        });
        
        const data = await response.json();
        
        if (data.ok) {
            window.location.href = '/admin';
        } else {
            errorDiv.textContent = 'Contrase√±a incorrecta';
            errorDiv.classList.add('show');
        }
    } catch (error) {
        console.error('Error:', error);
        errorDiv.textContent = 'Error de conexi√≥n';
        errorDiv.classList.add('show');
    }
}

async function loadHomeData() {
    await Promise.all([loadAlbums(), loadPlaylists(), loadArtists()]);
}

async function loadAlbums() {
    try {
        const response = await fetch('/api/albumes');
        const data = await response.json();
        
        const container = document.getElementById('albums-container');
        
        if (data.ok && data.albumes && data.albumes.length > 0) {
            container.innerHTML = data.albumes.map(album => `
                <div class="album-card" data-id="${album.id}" data-type="album">
                    <div class="album-cover">
                        <img src="${album.cover_url || 'https://via.placeholder.com/300x300/1a1a1a/6B5FCF?text=' + encodeURIComponent(album.titulo)}" 
                             alt="${album.titulo}"
                             onerror="this.src='https://via.placeholder.com/300x300/1a1a1a/6B5FCF?text=Album'">
                        <div class="play-overlay" data-action="play" data-album-id="${album.id}">
                            <i class="fas fa-play"></i>
                        </div>
                    </div>
                    <div class="album-info">
                        <h3>${album.titulo}</h3>
                        <p>${album.nombre_artista || 'Artista desconocido'}</p>
                    </div>
                </div>
            `).join('');
            
            container.querySelectorAll('.album-card').forEach(card => {
                card.addEventListener('click', async (e) => {
                    const playOverlay = e.target.closest('.play-overlay');
                    if (playOverlay) {
                        // REPRODUCIR DIRECTAMENTE
                        e.stopPropagation();
                        const albumId = parseInt(playOverlay.dataset.albumId);
                        await playAlbumFromHome(albumId);
                    } else {
                        // IR A VISTA DETALLADA
                        const albumId = parseInt(card.dataset.id);
                        showAlbumDetail(albumId);
                        addToHistory(`album:${albumId}`);
                    }
                });
            });
        } else {
            container.innerHTML = '<p class="loading">No hay √°lbumes disponibles.</p>';
        }
    } catch (error) {
        console.error('Error al cargar √°lbumes:', error);
        document.getElementById('albums-container').innerHTML = '<p class="loading">Error al cargar √°lbumes</p>';
    }
}

async function playAlbumFromHome(albumId) {
    try {
        const songsResponse = await fetch(`/api/albumes/${albumId}/canciones`);
        const songsData = await songsResponse.json();
        
        if (songsData.ok && songsData.canciones && songsData.canciones.length > 0) {
            const albumResponse = await fetch('/api/albumes');
            const albumData = await albumResponse.json();
            const album = albumData.albumes.find(a => a.id === albumId);
            
            const coverUrl = album?.cover_url || 'https://via.placeholder.com/300x300/1a1a1a/6B5FCF?text=Album';
            const canciones = songsData.canciones.map(c => ({
                ...c,
                cover_url: c.cover_url || coverUrl
            }));
            
            playAlbum(canciones, 0);
            showNotification(`Reproduciendo ${album?.titulo || '√°lbum'}`, 'success');
        }
    } catch (error) {
        console.error('Error al reproducir √°lbum:', error);
        showNotification('Error al cargar las canciones', 'error');
    }
}

async function loadPlaylists() {
    try {
        const response = await fetch('/api/playlists');
        const data = await response.json();
        
        const container = document.getElementById('playlists-container');
        
        if (data.ok && data.playlists && data.playlists.length > 0) {
            container.innerHTML = data.playlists.map(playlist => `
                <div class="album-card" data-id="${playlist.id}" data-type="playlist">
                    <div class="album-cover">
                        <img src="https://via.placeholder.com/300x300/1a1a1a/6B5FCF?text=${encodeURIComponent(playlist.nombre)}" 
                             alt="${playlist.nombre}">
                        <div class="play-overlay">
                            <i class="fas fa-play"></i>
                        </div>
                    </div>
                    <div class="album-info">
                        <h3>${playlist.nombre}</h3>
                        <p>${playlist.num_canciones || 0} canciones</p>
                    </div>
                </div>
            `).join('');
            
            container.querySelectorAll('.album-card').forEach(card => {
                card.addEventListener('click', (e) => {
                    if (!e.target.closest('.play-overlay')) {
                        const playlistId = parseInt(card.dataset.id);
                        showPlaylistDetail(playlistId);
                        addToHistory(`playlist:${playlistId}`);
                    }
                });
            });
        } else {
            container.innerHTML = '<p class="loading">No hay playlists.</p>';
        }
    } catch (error) {
        console.error('Error al cargar playlists:', error);
        document.getElementById('playlists-container').innerHTML = '<p class="loading">Error al cargar playlists</p>';
    }
}

async function loadArtists() {
    try {
        const response = await fetch('/api/artistas');
        const data = await response.json();
        
        const container = document.getElementById('artists-container');
        
        if (data.ok && data.artistas && data.artistas.length > 0) {
            container.innerHTML = data.artistas.map(artista => `
                <div class="artist-card" data-id="${artista.id}">
                    <div class="artist-avatar">
                        <img src="${artista.avatar_url || 'https://via.placeholder.com/300x300/1a1a1a/6B5FCF?text=' + encodeURIComponent(artista.nombre_artista)}" 
                             alt="${artista.nombre_artista}"
                             onerror="this.src='https://via.placeholder.com/300x300/1a1a1a/6B5FCF?text=Artist'">
                    </div>
                    <h3>${artista.nombre_artista}</h3>
                    <p>Artista${artista.verificado ? ' ‚úì' : ''}</p>
                </div>
            `).join('');
        } else {
            container.innerHTML = '<p class="loading">No hay artistas.</p>';
        }
    } catch (error) {
        console.error('Error al cargar artistas:', error);
        document.getElementById('artists-container').innerHTML = '<p class="loading">Error al cargar artistas</p>';
    }
}

// ==================== VISTA DETALLADA DE √ÅLBUM (CON LIKES Y MEN√ö) ====================

async function showAlbumDetail(albumId, skipHistory = false) {
    showDetailView();
    
    try {
        const albumResponse = await fetch('/api/albumes');
        const albumData = await albumResponse.json();
        const album = albumData.albumes.find(a => a.id === albumId);
        
        if (!album) return;
        
        currentAlbumData = {
            id: album.id,
            titulo: album.titulo,
            artista: album.nombre_artista,
            year: album.fecha_lanzamiento ? new Date(album.fecha_lanzamiento).getFullYear() : '2025',
            cover: album.cover_url || 'https://via.placeholder.com/300x300/1a1a1a/6B5FCF?text=Album'
        };
        
        document.getElementById('detail-type').textContent = '√ÅLBUM';
        document.getElementById('detail-title').textContent = currentAlbumData.titulo;
        document.getElementById('detail-cover-img').src = currentAlbumData.cover;
        document.getElementById('detail-artist').textContent = currentAlbumData.artista;
        document.getElementById('detail-year').textContent = currentAlbumData.year;
        
        const favResponse = await fetch(`/api/albumes/${albumId}/favorito/check`);
        const favData = await favResponse.json();
        
        const songsResponse = await fetch(`/api/albumes/${albumId}/canciones`);
        const songsData = await songsResponse.json();
        
        if (songsData.ok && songsData.canciones) {
            const canciones = songsData.canciones.map(c => ({
                ...c,
                cover_url: c.cover_url || currentAlbumData.cover
            }));
            
            document.getElementById('detail-tracks-count').textContent = `${canciones.length} canci√≥n${canciones.length !== 1 ? 'es' : ''}`;
            
            // Verificar favoritos de cada canci√≥n
            const favoritesChecks = await Promise.all(
                canciones.map(c => fetch(`/api/canciones/${c.id}/favorito/check`).then(r => r.json()))
            );
            
            const tracksList = document.getElementById('tracks-list');
            tracksList.innerHTML = canciones.map((cancion, index) => `
                <div class="track-row" data-track-id="${cancion.id}" data-track-index="${index}">
                    <span class="track-number">${index + 1}</span>
                    <button class="track-play-btn" style="display:none;">
                        <i class="fas fa-play"></i>
                    </button>
                    <div class="track-info-cell">
                        <span class="track-name">${cancion.titulo}</span>
                        <span class="track-artist-name">${cancion.nombre_artista || 'Desconocido'}</span>
                    </div>
                    <button class="track-like-btn ${favoritesChecks[index]?.is_favorite ? 'liked' : ''}" data-song-id="${cancion.id}">
                        <i class="fa${favoritesChecks[index]?.is_favorite ? 's' : 'r'} fa-heart"></i>
                    </button>
                    <span class="track-duration">${formatDuration(cancion.duracion_segundos || 0)}</span>
                    <button class="track-menu-btn" data-song-id="${cancion.id}" data-artist-id="${cancion.artista_id}">
                        <i class="fas fa-ellipsis"></i>
                    </button>
                </div>
            `).join('');
            
            tracksList.querySelectorAll('.track-row').forEach(row => {
                const playBtn = row.querySelector('.track-play-btn');
                const likeBtn = row.querySelector('.track-like-btn');
                const menuBtn = row.querySelector('.track-menu-btn');
                
                row.addEventListener('mouseenter', () => {
                    if (!row.classList.contains('playing')) {
                        row.querySelector('.track-number').style.display = 'none';
                        playBtn.style.display = 'flex';
                    }
                });
                
                row.addEventListener('mouseleave', () => {
                    if (!row.classList.contains('playing')) {
                        row.querySelector('.track-number').style.display = 'block';
                        playBtn.style.display = 'none';
                    }
                });
                
                row.addEventListener('click', (e) => {
                    if (!e.target.closest('.track-like-btn') && !e.target.closest('.track-menu-btn')) {
                        const trackIndex = parseInt(row.dataset.trackIndex);
                        
                        if (trackIndex === currentTrackIndex && currentAudio && currentAudio.src) {
                            if (currentAudio.paused) {
                                currentAudio.play();
                            } else {
                                currentAudio.pause();
                            }
                        } else {
                            playAlbum(canciones, trackIndex);
                        }
                    }
                });
                
                // Like button
                likeBtn.addEventListener('click', async (e) => {
                    e.stopPropagation();
                    await toggleSongLike(parseInt(likeBtn.dataset.songId), likeBtn);
                });
                
                // Menu button
                menuBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const songId = parseInt(menuBtn.dataset.songId);
                    const artistId = parseInt(menuBtn.dataset.artistId);
                    const cancion = canciones.find(c => c.id === songId);
                    showTrackMenu(e, cancion, artistId);
                });
            });
            
            const playAllBtn = document.getElementById('btn-play-all');
            const likeBtn = document.getElementById('btn-like-album');
            
            const newPlayAllBtn = playAllBtn.cloneNode(true);
            const newLikeBtn = likeBtn.cloneNode(true);
            
            playAllBtn.parentNode.replaceChild(newPlayAllBtn, playAllBtn);
            likeBtn.parentNode.replaceChild(newLikeBtn, likeBtn);
            
            if (favData.ok && favData.is_favorite) {
                newLikeBtn.querySelector('i').className = 'fas fa-heart';
                newLikeBtn.classList.add('liked');
            } else {
                newLikeBtn.querySelector('i').className = 'far fa-heart';
                newLikeBtn.classList.remove('liked');
            }
            
            newPlayAllBtn.addEventListener('click', () => {
                playAlbum(canciones, 0);
            });
            
            newLikeBtn.addEventListener('click', async () => {
                await addToFavorites(albumId, 'album');
            });
        }
        
    } catch (error) {
        console.error('Error al cargar detalles del √°lbum:', error);
    }
}

// Similar para showPlaylistDetail...
async function showPlaylistDetail(playlistId, skipHistory = false) {
    showDetailView();
    
    try {
        const playlistResponse = await fetch('/api/playlists');
        const playlistData = await playlistResponse.json();
        const playlist = playlistData.playlists.find(p => p.id === playlistId);
        
        if (!playlist) return;
        
        currentAlbumData = {
            id: playlist.id,
            titulo: playlist.nombre,
            artista: playlist.creador_nombre || currentUser.nombre,
            year: new Date(playlist.fecha_creacion).getFullYear(),
            cover: 'https://via.placeholder.com/300x300/1a1a1a/6B5FCF?text=' + encodeURIComponent(playlist.nombre)
        };
        
        document.getElementById('detail-type').textContent = 'PLAYLIST';
        document.getElementById('detail-title').textContent = currentAlbumData.titulo;
        document.getElementById('detail-cover-img').src = currentAlbumData.cover;
        document.getElementById('detail-artist').textContent = currentAlbumData.artista;
        document.getElementById('detail-year').textContent = currentAlbumData.year;
        
        const favResponse = await fetch(`/api/playlists/${playlistId}/favorito/check`);
        const favData = await favResponse.json();
        
        const songsResponse = await fetch(`/api/playlists/${playlistId}/canciones`);
        const songsData = await songsResponse.json();
        
        if (songsData.ok && songsData.canciones) {
            const canciones = songsData.canciones.map(c => ({
                ...c,
                cover_url: c.cover_url || currentAlbumData.cover
            }));
            
            document.getElementById('detail-tracks-count').textContent = `${canciones.length} canci√≥n${canciones.length !== 1 ? 'es' : ''}`;
            
            const favoritesChecks = await Promise.all(
                canciones.map(c => fetch(`/api/canciones/${c.id}/favorito/check`).then(r => r.json()))
            );
            
            const tracksList = document.getElementById('tracks-list');
            tracksList.innerHTML = canciones.map((cancion, index) => `
                <div class="track-row" data-track-id="${cancion.id}" data-track-index="${index}">
                    <span class="track-number">${index + 1}</span>
                    <button class="track-play-btn" style="display:none;">
                        <i class="fas fa-play"></i>
                    </button>
                    <div class="track-info-cell">
                        <span class="track-name">${cancion.titulo}</span>
                        <span class="track-artist-name">${cancion.nombre_artista || 'Desconocido'}</span>
                    </div>
                    <button class="track-like-btn ${favoritesChecks[index]?.is_favorite ? 'liked' : ''}" data-song-id="${cancion.id}">
                        <i class="fa${favoritesChecks[index]?.is_favorite ? 's' : 'r'} fa-heart"></i>
                    </button>
                    <span class="track-duration">${formatDuration(cancion.duracion_segundos || 0)}</span>
                    <button class="track-menu-btn" data-song-id="${cancion.id}" data-artist-id="${cancion.artista_id}">
                        <i class="fas fa-ellipsis"></i>
                    </button>
                </div>
            `).join('');
            
            tracksList.querySelectorAll('.track-row').forEach(row => {
                const playBtn = row.querySelector('.track-play-btn');
                const likeBtn = row.querySelector('.track-like-btn');
                const menuBtn = row.querySelector('.track-menu-btn');
                
                row.addEventListener('mouseenter', () => {
                    if (!row.classList.contains('playing')) {
                        row.querySelector('.track-number').style.display = 'none';
                        playBtn.style.display = 'flex';
                    }
                });
                
                row.addEventListener('mouseleave', () => {
                    if (!row.classList.contains('playing')) {
                        row.querySelector('.track-number').style.display = 'block';
                        playBtn.style.display = 'none';
                    }
                });
                
                row.addEventListener('click', (e) => {
                    if (!e.target.closest('.track-like-btn') && !e.target.closest('.track-menu-btn')) {
                        const trackIndex = parseInt(row.dataset.trackIndex);
                        
                        if (trackIndex === currentTrackIndex && currentAudio && currentAudio.src) {
                            if (currentAudio.paused) {
                                currentAudio.play();
                            } else {
                                currentAudio.pause();
                            }
                        } else {
                            playAlbum(canciones, trackIndex);
                        }
                    }
                });
                
                likeBtn.addEventListener('click', async (e) => {
                    e.stopPropagation();
                    await toggleSongLike(parseInt(likeBtn.dataset.songId), likeBtn);
                });
                
                menuBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const songId = parseInt(menuBtn.dataset.songId);
                    const artistId = parseInt(menuBtn.dataset.artistId);
                    const cancion = canciones.find(c => c.id === songId);
                    showTrackMenu(e, cancion, artistId);
                });
            });
            
            const playAllBtn = document.getElementById('btn-play-all');
            const likeBtn = document.getElementById('btn-like-album');
            
            const newPlayAllBtn = playAllBtn.cloneNode(true);
            const newLikeBtn = likeBtn.cloneNode(true);
            
            playAllBtn.parentNode.replaceChild(newPlayAllBtn, playAllBtn);
            likeBtn.parentNode.replaceChild(newLikeBtn, likeBtn);
            
            if (favData.ok && favData.is_favorite) {
                newLikeBtn.querySelector('i').className = 'fas fa-heart';
                newLikeBtn.classList.add('liked');
            } else {
                newLikeBtn.querySelector('i').className = 'far fa-heart';
                newLikeBtn.classList.remove('liked');
            }
            
            newPlayAllBtn.addEventListener('click', () => {
                playAlbum(canciones, 0);
            });
            
            newLikeBtn.addEventListener('click', async () => {
                await addToFavorites(playlistId, 'playlist');
            });
        }
        
    } catch (error) {
        console.error('Error al cargar detalles de la playlist:', error);
    }
}

// ==================== FUNCIONES NUEVAS ====================

async function toggleSongLike(songId, button) {
    try {
        const response = await fetch(`/api/canciones/${songId}/favorito`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'}
        });
        
        const data = await response.json();
        
        if (data.ok) {
            const icon = button.querySelector('i');
            if (data.added) {
                icon.className = 'fas fa-heart';
                button.classList.add('liked');
                showNotification('A√±adido a tus Me gusta', 'success');
            } else {
                icon.className = 'far fa-heart';
                button.classList.remove('liked');
                showNotification('Eliminado de tus Me gusta', 'info');
            }
        }
    } catch (error) {
        console.error('Error:', error);
        showNotification('Error al actualizar favorito', 'error');
    }
}

async function showTrackMenu(event, cancion, artistId) {
    // Cerrar men√∫ anterior si existe
    const existingMenu = document.querySelector('.track-context-menu');
    if (existingMenu) existingMenu.remove();
    
    // Obtener playlists del usuario
    const playlistsResponse = await fetch('/api/playlists');
    const playlistsData = await playlistsResponse.json();
    const userPlaylists = playlistsData.playlists || [];
    
    // Crear men√∫
    const menu = document.createElement('div');
    menu.className = 'track-context-menu';
    menu.innerHTML = `
        <div class="context-menu-item" data-action="artist" data-artist-id="${artistId}">
            <i class="fas fa-user"></i>
            <span>Ir al artista</span>
        </div>
        <div class="context-menu-divider"></div>
        <div class="context-menu-item submenu-trigger">
            <i class="fas fa-plus"></i>
            <span>A√±adir a playlist</span>
            <i class="fas fa-chevron-right"></i>
        </div>
        <div class="context-submenu">
            ${userPlaylists.map(p => `
                <div class="context-menu-item" data-action="add-playlist" data-playlist-id="${p.id}" data-song-id="${cancion.id}">
                    <i class="fas fa-music"></i>
                    <span>${p.nombre}</span>
                </div>
            `).join('')}
            ${userPlaylists.length === 0 ? '<div class="context-menu-item disabled"><span>No tienes playlists</span></div>' : ''}
        </div>
        <div class="context-menu-divider"></div>
        <div class="context-menu-item" data-action="remove-like" data-song-id="${cancion.id}">
            <i class="fas fa-heart-crack"></i>
            <span>Quitar de Me gusta</span>
        </div>
    `;
    
    // Posicionar men√∫
    document.body.appendChild(menu);
    
    const rect = event.target.getBoundingClientRect();
    menu.style.top = `${rect.bottom + 5}px`;
    menu.style.left = `${rect.left}px`;
    
    // Ajustar si se sale de la pantalla
    const menuRect = menu.getBoundingClientRect();
    if (menuRect.right > window.innerWidth) {
        menu.style.left = `${window.innerWidth - menuRect.width - 10}px`;
    }
    if (menuRect.bottom > window.innerHeight) {
        menu.style.top = `${rect.top - menuRect.height - 5}px`;
    }
    
    // Event listeners
    menu.querySelectorAll('.context-menu-item:not(.disabled)').forEach(item => {
        item.addEventListener('click', async (e) => {
            const action = item.dataset.action;
            
            if (action === 'artist') {
                showNotification('Funci√≥n "Ir al artista" pr√≥ximamente', 'info');
            } else if (action === 'add-playlist') {
                const playlistId = parseInt(item.dataset.playlistId);
                const songId = parseInt(item.dataset.songId);
                await addSongToPlaylist(songId, playlistId);
            } else if (action === 'remove-like') {
                const songId = parseInt(item.dataset.songId);
                await removeSongLike(songId);
            }
            
            menu.remove();
        });
    });
    
    // Submenu toggle
    const submenuTrigger = menu.querySelector('.submenu-trigger');
    const submenu = menu.querySelector('.context-submenu');
    submenuTrigger.addEventListener('mouseenter', () => {
        submenu.classList.add('show');
    });
    menu.addEventListener('mouseleave', () => {
        submenu.classList.remove('show');
    });
    
    // Cerrar al hacer click fuera
    setTimeout(() => {
        document.addEventListener('click', function closeMenu(e) {
            if (!menu.contains(e.target)) {
                menu.remove();
                document.removeEventListener('click', closeMenu);
            }
        });
    }, 100);
}

async function addSongToPlaylist(songId, playlistId) {
    try {
        const response = await fetch(`/api/playlists/${playlistId}/agregar-cancion`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ cancion_id: songId })
        });
        
        const data = await response.json();
        
        if (data.ok) {
            showNotification('Canci√≥n a√±adida a la playlist', 'success');
        } else {
            showNotification(data.mensaje || 'Error al a√±adir', 'error');
        }
    } catch (error) {
        console.error('Error:', error);
        showNotification('Error de conexi√≥n', 'error');
    }
}

async function removeSongLike(songId) {
    try {
        const response = await fetch(`/api/canciones/${songId}/favorito`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'}
        });
        
        const data = await response.json();
        
        if (data.ok) {
            showNotification('Eliminado de Me gusta', 'info');
            // Actualizar UI
            const likeBtn = document.querySelector(`[data-song-id="${songId}"].track-like-btn`);
            if (likeBtn) {
                likeBtn.querySelector('i').className = 'far fa-heart';
                likeBtn.classList.remove('liked');
            }
        }
    } catch (error) {
        console.error('Error:', error);
        showNotification('Error al eliminar', 'error');
    }
}


function updateQueue() {
    const queueList = document.getElementById('queue-list');
    if (currentPlaylist.length === 0) {
        queueList.innerHTML = `
            <div class="empty-queue">
                <i class="fas fa-music"></i>
                <p>Selecciona un √°lbum o playlist</p>
            </div>
        `;
        return;
    }
    
    const remainingSongs = currentPlaylist.slice(currentTrackIndex);
    
    if (remainingSongs.length === 0) {
        queueList.innerHTML = `
            <div class="empty-queue">
                <i class="fas fa-music"></i>
                <p>No hay m√°s canciones en la cola</p>
            </div>
        `;
        return;
    }
    
    queueList.innerHTML = remainingSongs.map((cancion, index) => {
        const actualIndex = currentTrackIndex + index;
        const isDraggable = index !== 0;
        
        return `
            <div class="queue-item ${index === 0 ? 'active' : ''}" 
                 data-index="${actualIndex}"
                 ${isDraggable ? 'draggable="true"' : ''}
                 ${isDraggable ? 'data-draggable="true"' : ''}>
                <div class="queue-item-cover">
                    <img src="${cancion.cover_url || 'https://via.placeholder.com/48x48/1a1a1a/6B5FCF?text=M'}" alt="${cancion.titulo}">
                </div>
                <div class="queue-item-info">
                    <h5>${cancion.titulo}</h5>
                    <p>${cancion.nombre_artista || 'Desconocido'}</p>
                </div>
                ${isDraggable ? `<button class="queue-item-remove" data-index="${actualIndex}"><i class="fas fa-times"></i></button>` : ''}
            </div>
        `;
    }).join('');
    
    // Event listeners para clicks
    queueList.querySelectorAll('.queue-item').forEach(item => {
        item.addEventListener('click', (e) => {
            if (!e.target.closest('.queue-item-remove')) {
                const index = parseInt(item.dataset.index);
                currentTrackIndex = index;
                playTrack(currentPlaylist[index]);
            }
        });
    });
    
    // Event listeners para eliminar
    queueList.querySelectorAll('.queue-item-remove').forEach(btn => {
        btn.addEventListener('click', (e) => {
            e.stopPropagation();
            const index = parseInt(btn.dataset.index);
            removeFromQueue(index);
        });
    });
    
    // Configurar drag and drop
    setupDragAndDrop();
}
function removeFromQueue(index) {
    if (index === currentTrackIndex) {
        showNotification('No puedes eliminar la canci√≥n actual', 'info');
        return;
    }
    
    currentPlaylist.splice(index, 1);
    
    if (index < currentTrackIndex) {
        currentTrackIndex--;
    }
    
    updateQueue();
    showNotification('Canci√≥n eliminada de la cola', 'info');
}


// ==================== DRAG AND DROP ====================

// ==================== DRAG AND DROP CON AUTO-SCROLL ====================

let draggedItem = null;
let draggedIndex = null;
let autoScrollInterval = null;

function setupDragAndDrop() {
    const queueItems = document.querySelectorAll('.queue-item[draggable="true"]');
    const queueContainer = document.querySelector('.queue-section');
    
    queueItems.forEach(item => {
        // Drag start
        item.addEventListener('dragstart', (e) => {
            draggedItem = item;
            draggedIndex = parseInt(item.dataset.index);
            item.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/plain', draggedIndex);
            
            // A√±adir clase al contenedor para indicar que est√° en modo drag
            queueContainer.classList.add('is-dragging');
        });
        
        // Drag end
        item.addEventListener('dragend', (e) => {
            item.classList.remove('dragging');
            queueContainer.classList.remove('is-dragging');
            document.querySelectorAll('.queue-item').forEach(i => {
                i.classList.remove('drag-over', 'drag-over-bottom');
            });
            
            // Limpiar auto-scroll
            if (autoScrollInterval) {
                clearInterval(autoScrollInterval);
                autoScrollInterval = null;
            }
            
            draggedItem = null;
            draggedIndex = null;
        });
        
        // Drag over
        item.addEventListener('dragover', (e) => {
            if (e.preventDefault) {
                e.preventDefault();
            }
            e.dataTransfer.dropEffect = 'move';
            
            if (draggedItem && item !== draggedItem && item.dataset.draggable === 'true') {
                const rect = item.getBoundingClientRect();
                const midpoint = rect.top + rect.height / 2;
                
                // Limpiar clases anteriores
                document.querySelectorAll('.queue-item').forEach(i => {
                    i.classList.remove('drag-over', 'drag-over-bottom');
                });
                
                // A√±adir clase seg√∫n la posici√≥n
                if (e.clientY < midpoint) {
                    item.classList.add('drag-over');
                } else {
                    item.classList.add('drag-over-bottom');
                }
            }
            
            // Auto-scroll cuando est√° cerca de los bordes
            handleAutoScroll(e, queueContainer);
            
            return false;
        });
        
        // Drag enter
        item.addEventListener('dragenter', (e) => {
            if (item !== draggedItem && item.dataset.draggable === 'true') {
                e.preventDefault();
            }
        });
        
        // Drag leave
        item.addEventListener('dragleave', (e) => {
            item.classList.remove('drag-over', 'drag-over-bottom');
        });
        
        // Drop
        item.addEventListener('drop', (e) => {
            if (e.stopPropagation) {
                e.stopPropagation();
            }
            e.preventDefault();
            
            if (draggedItem && draggedItem !== item) {
                const dropIndex = parseInt(item.dataset.index);
                const rect = item.getBoundingClientRect();
                const midpoint = rect.top + rect.height / 2;
                
                // Determinar si insertar antes o despu√©s
                const insertBefore = e.clientY < midpoint;
                
                reorderQueue(draggedIndex, dropIndex, insertBefore);
            }
            
            item.classList.remove('drag-over', 'drag-over-bottom');
            
            return false;
        });
    });
    
    // Drag sobre el contenedor vac√≠o
    const queueList = document.getElementById('queue-list');
    queueList.addEventListener('dragover', (e) => {
        if (e.preventDefault) {
            e.preventDefault();
        }
        handleAutoScroll(e, queueContainer);
    });
}

function handleAutoScroll(e, container) {
    const containerRect = container.getBoundingClientRect();
    const scrollZone = 50; // Zona de 50px en la parte superior e inferior
    const scrollSpeed = 10; // Velocidad de scroll
    
    // Limpiar intervalo anterior
    if (autoScrollInterval) {
        clearInterval(autoScrollInterval);
        autoScrollInterval = null;
    }
    
    // Scroll hacia arriba
    if (e.clientY < containerRect.top + scrollZone) {
        autoScrollInterval = setInterval(() => {
            container.scrollTop -= scrollSpeed;
        }, 20);
    }
    // Scroll hacia abajo
    else if (e.clientY > containerRect.bottom - scrollZone) {
        autoScrollInterval = setInterval(() => {
            container.scrollTop += scrollSpeed;
        }, 20);
    }
}

function reorderQueue(fromIndex, toIndex, insertBefore) {
    if (fromIndex === toIndex) return;
    
    // No permitir mover antes de la canci√≥n actual
    if (toIndex === currentTrackIndex && insertBefore) {
        showNotification('No puedes mover canciones antes de la actual', 'info');
        updateQueue();
        return;
    }
    
    // Obtener la canci√≥n a mover
    const song = currentPlaylist[fromIndex];
    
    // Calcular nueva posici√≥n
    let newPosition;
    if (insertBefore) {
        newPosition = toIndex;
    } else {
        newPosition = toIndex + 1;
    }
    
    // Ajustar si movemos hacia atr√°s
    if (fromIndex < newPosition) {
        newPosition--;
    }
    
    // Remover de la posici√≥n original
    currentPlaylist.splice(fromIndex, 1);
    
    // Insertar en la nueva posici√≥n
    currentPlaylist.splice(newPosition, 0, song);
    
    // Actualizar currentTrackIndex si es necesario
    if (fromIndex === currentTrackIndex) {
        currentTrackIndex = newPosition;
    } else if (fromIndex < currentTrackIndex && newPosition >= currentTrackIndex) {
        currentTrackIndex--;
    } else if (fromIndex > currentTrackIndex && newPosition <= currentTrackIndex) {
        currentTrackIndex++;
    }
    
    // Actualizar la cola
    updateQueue();
    showNotification('‚úì Cola reordenada', 'success');
}


// ==================== REPRODUCCI√ìN ====================

function initializeAudioPlayer() {
    if (!currentAudio) {
        currentAudio = document.getElementById('audio-player');
        
        currentAudio.addEventListener('timeupdate', () => {
            if (currentAudio.duration) {
                const progress = (currentAudio.currentTime / currentAudio.duration) * 100;
                document.getElementById('progress-bar').value = progress;
                document.getElementById('time-current').textContent = formatDuration(Math.floor(currentAudio.currentTime));
            }
        });
        
        currentAudio.addEventListener('loadedmetadata', () => {
            document.getElementById('time-total').textContent = formatDuration(Math.floor(currentAudio.duration));
        });
        
        currentAudio.addEventListener('ended', () => {
            if (isRepeatOn) {
                currentAudio.currentTime = 0;
                currentAudio.play();
            } else {
                playNext();
            }
        });
        
        currentAudio.addEventListener('play', () => {
            document.querySelector('#btn-play i').className = 'fas fa-pause';
            updatePlayButtonInTrack(true);
        });
        
        currentAudio.addEventListener('pause', () => {
            document.querySelector('#btn-play i').className = 'fas fa-play';
            updatePlayButtonInTrack(false);
        });
        
        currentAudio.addEventListener('error', (e) => {
            console.error('Error al cargar audio:', e);
            showNotification('Error al reproducir la canci√≥n', 'error');
        });
    }
}

function updatePlayButtonInTrack(isPlaying) {
    const activeTrack = document.querySelector('.track-row.playing');
    if (activeTrack) {
        const playBtn = activeTrack.querySelector('.track-play-btn i');
        if (playBtn) {
            playBtn.className = isPlaying ? 'fas fa-pause' : 'fas fa-play';
        }
    }
}

function playAlbum(canciones, startIndex = 0) {
    initializeAudioPlayer();
    currentPlaylist = canciones;
    currentTrackIndex = startIndex;
    playTrack(canciones[startIndex]);
    updateQueue();
}

function playTrack(cancion) {
    initializeAudioPlayer();
    
    document.getElementById('track-title').textContent = cancion.titulo;
    document.getElementById('track-artist').textContent = cancion.nombre_artista || 'Desconocido';
    
    let coverUrl = cancion.cover_url || '';
    
    if (!coverUrl && currentAlbumData) {
        coverUrl = currentAlbumData.cover;
    }
    
    if (!coverUrl) {
        coverUrl = 'https://via.placeholder.com/300x300/1a1a1a/6B5FCF?text=Mixy';
    }
    
    document.getElementById('track-cover').src = coverUrl;
    
    let audioUrl = cancion.archivo_url || '';
    
    if (audioUrl.startsWith('statics/')) {
        audioUrl = audioUrl.replace('statics/', 'static/');
    }
    if (audioUrl.includes('/upload/')) {
        audioUrl = audioUrl.replace('/upload/', '/uploads/');
    }
    
    if (audioUrl && !audioUrl.startsWith('http') && !audioUrl.startsWith('/')) {
        audioUrl = '/' + audioUrl;
    }
    
    console.log('üéµ Reproduciendo:', cancion.titulo, 'URL:', audioUrl);
    
    currentAudio.src = audioUrl;
    currentAudio.load();
    currentAudio.play().catch(err => {
        console.error('Error al reproducir:', err);
        showNotification('Error al reproducir el archivo', 'error');
    });
    
    document.querySelectorAll('.track-row').forEach(row => {
        row.classList.remove('playing');
        row.querySelector('.track-number').style.display = 'block';
        row.querySelector('.track-play-btn').style.display = 'none';
    });
    
    const activeTrack = document.querySelector(`[data-track-index="${currentTrackIndex}"]`);
    if (activeTrack) {
        activeTrack.classList.add('playing');
        activeTrack.querySelector('.track-number').style.display = 'none';
        activeTrack.querySelector('.track-play-btn').style.display = 'flex';
        activeTrack.querySelector('.track-play-btn i').className = 'fas fa-pause';
    }
    
    updateQueue();
}

function playNext() {
    if (currentPlaylist.length === 0) {
        showNotification('No hay m√°s canciones', 'info');
        return;
    }
    
    if (isShuffleOn) {
        const remainingIndices = [];
        for (let i = currentTrackIndex + 1; i < currentPlaylist.length; i++) {
            remainingIndices.push(i);
        }
        
        if (remainingIndices.length === 0) {
            showNotification('Se acab√≥ la cola', 'info');
            return;
        }
        
        const randomIndex = remainingIndices[Math.floor(Math.random() * remainingIndices.length)];
        currentTrackIndex = randomIndex;
    } else {
        currentTrackIndex++;
        
        if (currentTrackIndex >= currentPlaylist.length) {
            showNotification('Se acab√≥ la cola', 'info');
            currentTrackIndex = currentPlaylist.length - 1;
            return;
        }
    }
    
    playTrack(currentPlaylist[currentTrackIndex]);
}

function playPrevious() {
    if (currentPlaylist.length === 0) return;
    
    if (currentAudio && currentAudio.currentTime > 3) {
        currentAudio.currentTime = 0;
        return;
    }
    
    currentTrackIndex = (currentTrackIndex - 1 + currentPlaylist.length) % currentPlaylist.length;
    playTrack(currentPlaylist[currentTrackIndex]);
}


function setupPlayerControls() {
    initializeAudioPlayer();
    
    document.getElementById('btn-play').addEventListener('click', () => {
        if (!currentAudio || !currentAudio.src) {
            showNotification('Selecciona una canci√≥n primero', 'info');
            return;
        }
        
        if (currentAudio.paused) {
            currentAudio.play();
        } else {
            currentAudio.pause();
        }
    });
    
    document.getElementById('btn-next').addEventListener('click', playNext);
    document.getElementById('btn-prev').addEventListener('click', playPrevious);
    
    document.getElementById('btn-shuffle').addEventListener('click', (e) => {
        isShuffleOn = !isShuffleOn;
        e.currentTarget.classList.toggle('active', isShuffleOn);
        showNotification(`Aleatorio ${isShuffleOn ? 'activado' : 'desactivado'}`, 'info');
    });
    
    document.getElementById('btn-repeat').addEventListener('click', (e) => {
        isRepeatOn = !isRepeatOn;
        e.currentTarget.classList.toggle('active', isRepeatOn);
        showNotification(`Repetir ${isRepeatOn ? 'activado' : 'desactivado'}`, 'info');
    });
    
    document.getElementById('progress-bar').addEventListener('input', (e) => {
        if (currentAudio && currentAudio.duration) {
            const time = (e.target.value / 100) * currentAudio.duration;
            currentAudio.currentTime = time;
        }
    });
    
    const volumeSlider = document.getElementById('volume-slider');
    volumeSlider.addEventListener('input', (e) => {
        if (currentAudio) {
            currentAudio.volume = e.target.value / 100;
        }
    });
    
    if (currentAudio) {
        currentAudio.volume = volumeSlider.value / 100;
    }
}

async function addToFavorites(id, type) {
    try {
        const endpoint = type === 'album' ? `/api/albumes/${id}/favorito` : `/api/playlists/${id}/favorito`;
        
        const response = await fetch(endpoint, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'}
        });
        
        const data = await response.json();
        
        if (data.ok) {
            const likeBtn = document.getElementById('btn-like-album');
            const icon = likeBtn.querySelector('i');
            
            if (data.added) {
                icon.className = 'fas fa-heart';
                likeBtn.classList.add('liked');
                showNotification('A√±adido a tu biblioteca ‚ù§Ô∏è', 'success');
            } else {
                icon.className = 'far fa-heart';
                likeBtn.classList.remove('liked');
                showNotification('Eliminado de tu biblioteca', 'info');
            }
        } else {
            showNotification('Error al agregar a favoritos', 'error');
        }
    } catch (error) {
        console.error('Error:', error);
        showNotification('Error de conexi√≥n', 'error');
    }
}

function showNotification(message, type = 'success') {
    const existingNotif = document.querySelector('.notification');
    if (existingNotif) existingNotif.remove();
    
    const notification = document.createElement('div');
    notification.className = `notification notification-${type}`;
    
    const iconMap = {
        success: 'check-circle',
        error: 'exclamation-circle',
        info: 'info-circle'
    };
    
    notification.innerHTML = `
        <i class="fas fa-${iconMap[type] || 'info-circle'}"></i>
        <span>${message}</span>
        <div class="notification-progress"></div>
    `;
    
    document.body.appendChild(notification);
    setTimeout(() => notification.classList.add('show'), 10);
    setTimeout(() => {
        notification.classList.remove('show');
        setTimeout(() => notification.remove(), 300);
    }, 3000);
}

function formatDuration(seconds) {
    if (!seconds || isNaN(seconds)) return '0:00';
    const mins = Math.floor(seconds / 60);
    const secs = Math.floor(seconds % 60);
    return `${mins}:${secs.toString().padStart(2, '0')}`;
}

console.log('‚úÖ Mixy Home.js completo');
    </script>
</body>
</html>
